var WCST={};WCST.Helpers={},WCST.Views={},WCST.Events={},_.extend(WCST.Events,Backbone.Events),WCST.Helpers.uniqid=function(a,b){void 0===a&&(a="");var c,d=function(a,b){return a=parseInt(a,10).toString(16),b<a.length?a.slice(a.length-b):b>a.length?Array(b-a.length+1).join("0")+a:a};return this.php_js||(this.php_js={}),this.php_js.uniqidSeed||(this.php_js.uniqidSeed=Math.floor(123456789*Math.random())),this.php_js.uniqidSeed++,c=a,c+=d(parseInt((new Date).getTime()/1e3,10),8),c+=d(this.php_js.uniqidSeed,5),b&&(c+=(10*Math.random()).toFixed(8).toString()),c},jQuery(function(a){if("undefined"!=typeof pagenow&&"wcst_trigger"===pagenow){a("#wcst_settings_location").change(function(){"custom:custom"==a(this).val()?a(".wcst-settings-custom").show():a(".wcst-settings-custom").hide()}),a("#wcst_settings_location").trigger("change");var b=function(){a(".wcst-date-picker-field").datepicker({dateFormat:"yy-mm-dd",numberOfMonths:1,showButtonPanel:!0}),a(".wcst-time-picker-field").mask("99 : 99"),a("select.chosen_select").xlChosen(),a("select.ajax_chosen_select_products").xlAjaxChosen({method:"GET",url:WCSTParams.ajax_url,dataType:"json",afterTypeDelay:100,data:{action:"woocommerce_json_search_products",security:WCSTParams.search_products_nonce}},function(b){var c={};return a.each(b,function(a,b){c[a]=b}),c}),a("select.ajax_chosen_select").each(function(b){a(b).xlAjaxChosen({method:"GET",url:WCSTParams.ajax_url,dataType:"json",afterTypeDelay:100,data:{action:"wcst_json_search",method:a(b).data("method"),security:WCSTParams.ajax_chosen}},function(b){var c={};return a.each(b,function(a,b){c[a]=b}),c})})};b(),a("#wcst-rules-groups").on("change","select.rule_type",function(){var c=a(this).closest("tr"),d=c.data("ruleid"),e=c.closest("table").data("groupid"),f={action:"wcst_change_rule_type",security:WCSTParams.ajax_nonce,group_id:e,rule_id:d,rule_type:a(this).val()};c.find("td.condition").html("").remove(),c.find("td.operator").html("").remove(),c.find("td.loading").show(),c.find("td.rule-type select").prop("disabled",!0),a.ajax({url:ajaxurl,data:f,type:"post",dataType:"html",success:function(a){c.find("td.loading").hide().before(a),c.find("td.rule-type select").prop("disabled",!1),b()}})});var c=Backbone.View.extend({groupCount:0,el:"#wcst-rules-groups",events:{"click .wcst-add-rule-group":"addRuleGroup"},render:function(){this.$target=this.$(".wcst-rule-group-target"),WCST.Events.bind("wcst:remove-rule-group",this.removeRuleGroup,this),this.views={};var b=this.$("div.wcst-rule-group-container");_.each(b,function(b){this.groupCount++;var c=a(b).data("groupid"),e=new d({el:b,model:new Backbone.Model({groupId:c,groupCount:this.groupCount,headerText:this.groupCount>1?WCSTParams.text_or:WCSTParams.text_apply_when,removeText:WCSTParams.remove_text})});this.views[c]=e,e.bind("wcst:remove-rule-group",this.removeRuleGroup,this)},this),this.groupCount>0&&a(".rules_or").show()},addRuleGroup:function(c){c.preventDefault();var e="group"+WCST.Helpers.uniqid();this.groupCount++;var f=new d({model:new Backbone.Model({groupId:e,groupCount:this.groupCount,headerText:this.groupCount>1?WCSTParams.text_or:WCSTParams.text_apply_when,removeText:WCSTParams.remove_text})});return this.$target.append(f.render().el),this.views[e]=f,f.bind("wcst:remove-rule-group",this.removeRuleGroup,this),this.groupCount>0&&a(".rules_or").show(),b(),!1},removeRuleGroup:function(a){delete this.views[a.model.get("groupId")],a.remove()}}),d=Backbone.View.extend({tagName:"div",className:"wcst-rule-group-container",template:_.template('<div class="wcst-rule-group-header"><h4><%= headerText %></h4><a href="#" class="wcst-remove-rule-group button"><%= removeText %></a></div><table class="wcst-rules" data-groupid="<%= groupId %>"><tbody></tbody></table>'),events:{"click .wcst-remove-rule-group":"onRemoveGroupClick"},initialize:function(){this.views={},this.$rows=this.$el.find("table.wcst-rules tbody");var b=this.$("tr.wcst-rule");_.each(b,function(b){var c=a(b).data("ruleid"),d=new e({el:b,model:new Backbone.Model({groupId:this.model.get("groupId"),ruleId:c})});d.delegateEvents(),d.bind("wcst:add-rule",this.onAddRule,this),d.bind("wcst:remove-rule",this.onRemoveRule,this),this.views.ruleId=d},this)},render:function(){return this.$el.html(this.template(this.model.toJSON())),this.$rows=this.$el.find("table.wcst-rules tbody"),this.$el.attr("data-groupid",this.model.get("groupId")),this.onAddRule(null),this},onAddRule:function(a){var c="rule"+WCST.Helpers.uniqid(),d=new e({model:new Backbone.Model({groupId:this.model.get("groupId"),ruleId:c})});null==a?this.$rows.append(d.render().el):a.$el.after(d.render().el),d.bind("wcst:add-rule",this.onAddRule,this),d.bind("wcst:remove-rule",this.onRemoveRule,this),b(),this.views.ruleId=d},onRemoveRule:function(b){var c=b.model.get("ruleId");1!=a("#wcst-rules-groups table tr.wcst-rule").length&&(delete this.views[c],b.remove(),""==a("table[data-groupid='"+this.model.get("groupId")+"'] tbody").html()&&(WCST.Events.trigger("wcst:removing-rule-group",this),this.trigger("wcst:remove-rule-group",this)))},onRemoveGroupClick:function(a){return a.preventDefault(),WCST.Events.trigger("wcst:removing-rule-group",this),this.trigger("wcst:remove-rule-group",this),!1}}),e=Backbone.View.extend({tagName:"tr",className:"wcst-rule",template:_.template(a("#wcst-rule-template").html()),events:{"click .wcst-add-rule":"onAddClick","click .wcst-remove-rule":"onRemoveClick"},render:function(){return this.$el.html(this.template(this.model.toJSON())),this.$el.attr("data-ruleid",this.model.get("ruleId")),this},onAddClick:function(a){return a.preventDefault(),WCST.Events.trigger("wcst:adding-rule",this),this.trigger("wcst:add-rule",this),!1},onRemoveClick:function(a){return a.preventDefault(),WCST.Events.trigger("wcst:removing-rule",this),this.trigger("wcst:remove-rule",this),!1}});(new c).render()}});